//From origin/asset/util.js
define('util',['avalon','mmRouter','events','json','dialog'],function(d,i,k,j,l){var h=this,f=document,b=this.erp,c=b.page,a={},g=Array.prototype.slice,e=new k();return c.pageEvent=e,a=_.extend(a,{generateID:function(){return'q13'+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);},ajax:function(b){return b=[],function(f,e){f=_.extend({dataType:'json'},f||{}),e=_.extend({mask:!1,ajaxType:'none',withData:!0},e||{});var c,k,n,g,l,h;e.mask===!0?(c=$('.ajax-global-mask'),c.length===0&&(c=$('<div class="ajax-mask ajax-global-mask"></div>'),c.html('<div class="ajax-mask-inner"></div>'),c.appendTo('body')),c.show()):e.mask!==!1&&(c=$('<div class="ajax-mask ajax-part-mask"></div>'),c.html('<div class="ajax-mask-inner"></div>'),c.hide().appendTo('body'),k=$(e.mask),l=function(){n=k.offset(),c.css({top:n.top,left:n.left,width:k.outerWidth(),height:k.outerHeight()});},h=function(){clearTimeout(g),g=setTimeout(function(){l();},300);},$(window).bind('resize',h),d.nextTick(function(){l(),c.show();}));var m=!1;if((e.ajaxType=='abort'||e.ajaxType=='ignore')&&(_.some(b,function(a){var c=a.data,d=a.url,b,g;return d==f.url&&(!e.withData||e.withData&&_.isEqual(c,f.data))&&(b=a.xhr,g=b.state(),g==='pending')?(e.ajaxType=='abort'?b.abort():m=!0,!0):void 0;}),m))return;var i,j;return i=$.ajax(f),j=a.generateID(),i.always(function(){e.mask===!0?_.every(_.filter(b,function(a){return a.id!=j&&a.mask===!0;}),function(a){return a.xhr.state()!=='pending';})&&c.hide():e.mask!==!1&&(c.remove(),c=null,g&&clearTimeout(g)&&(g=null),h&&$(window).unbind('resize',h)&&(h=null)),b=_.reject(b,function(a){return a.id==j;});}),b.push({xhr:i,url:f.url,data:f.data,id:j,mask:e.mask}),i;};}(),c2s:function(c,e){var d;return c.type=c.type||'post',c.dataType=c.dataType||'json',e=_.extend({mask:!0,ajaxType:'ignore',withData:!0},e||{}),d=a.ajax(c,e),d&&(d.done(function(c){c.flag||(c.timeout?location.href=b.BASE_PATH+'login.jsp':a.alert({content:c.message,iconType:'error'}));}),d.fail(function(){a.alert({content:'\u670D\u52A1\u7AEF\u8BF7\u6C42\u5931\u8D25',iconType:'error'});})),d;},regRouter:function(q,h,j){var l,k=$(q),f;!j&&_.isFunction(h)&&(j=h,h=q),l=$(h),f=$('.page-mask',l);var m=function(c){var b=[];return _.each(c,function(c){var d=c.belongToPermission;if(!d.length)return;(d==='all'||_.some(d,function(b){return a.hasPermission(b);}))&&(c.route&&b.push(_.extend({},c)),c.children&&(b=b.concat(m(c.children))));}),b;},n=function(c){var b=[];return _.each(c,function(c){var e,d=c.belongToPermission;if(!d.length)return;(d==='all'||_.some(d,function(b){return a.hasPermission(b);}))&&(e=_.extend({},c),b.push(e),c.children&&(e.children=n(c.children)));}),b;},o=function(d,h){var g=c.cacheStore,a=g[d],b=a.pageEl;$('.page-state-active',k).removeClass('page-state-active'),b.addClass('page-state-active'),f.hide(),h||e.trigger('switched',b,d,a.routeData);},p=function(a){var b=c.cacheStore,f=b[a],h=f.routeData,g=f.pageEl;f.$remove(g,a,h),g.off(),g.remove(),b[a]=null,delete b[a],d.vmodels[a]=null,delete d.vmodels[a],e.trigger('removed',a);};f.length===0&&(f=$('<div class="page-mask"></div>'),f.appendTo(l)),a.ajax({url:b.PAGE_PATH+'router.json',dataType:'json',type:'get',success:function(d){var a=d.rows;c.routes=n(a),c.lastPagePath='',c.lastRoute='',c.lastRouteData=null,_.each(m(a),function(a){var j=a.route,d=[].concat(a.css),l=[].concat(a.js),m=a.html,r=a.isCache,n,h,q;i.router.get(j,function(){var w=this,i=j.slice(1),s,v,u=c.cacheStore||{},t=c.lastPagePath;if(i=i.replace(/\(.+\)/g,''),i=i.replace(/\/:.+/g,''),i=i.replace(/\/\?.+/g,''),s=i.replace(/\//g,'-'),v=i.split('/').pop(),s='page-'+s,e.trigger('beforeswitch',s,_.extend({},a))===!1)return;if(t&&(t=t.replace(/\//g,'-'),t='page-'+t,u[t]&&!u[t].isCache&&p(t)),c.lastPagePath=i,c.lastRoute=j,c.lastRouteData=a,f.show(),u[s]&&u[s].isCache){o(s);return;}n||(b.PUBLISH_MODEL==='development'?d=_.map(d,function(a){return a===!0?'css!'+b.PAGE_PATH+i+'/'+v+'.css':'css!'+b.ORIGIN_PATH+a;}):d=[],l=_.map(l,function(c){var a;return c===!0?a=b.PAGE_PATH+i+'/'+v+'.js':a=b.ORIGIN_PATH+c,b.PUBLISH_MODEL==='development'?a:b.PUBLISH_MODEL==='product'?a.slice(b.PORTAL_PATH.length).replace(/[\.|\\|/|_|-]/g,''):void 0;}),m?m===!0?h='text!'+b.PAGE_PATH+i+'/'+v+'.html':h='text!'+b.ORIGIN_PATH+m:h='text!'+b.PAGE_PATH+i+'/'+v+'.html',n=d.concat(h,l)),setTimeout(function(){require(n,function(){var i=g.call(arguments,0),l=q||i[0],j=i[i.length-1],f={};_.extend(f,a,w);var b=$('<div></div>');b.addClass('page '+s).attr('ms-controller',s).appendTo(k),b.html(l),q||(q=l,n.splice(d.length,1)),j.$init?j.$init(b,s,f):alert('\u8BF7\u5728\u9875\u9762\uFF08'+h+'\uFF09\u903B\u8F91\u4E2D\u8BBE\u7F6E$init\u521D\u59CB\u5316\u51FD\u6570'),u[s]={pageEl:b,isCache:r,routeData:f,$remove:j.$remove||function(){}},c.cacheStore=u,o(s,!0),e.trigger('inited',b,s,f);});},300);});}),i.history.start({html5Mode:!1}),j&&j.call(this,d);}});},isIE:function(b){var a=f.createElement('b');return a.innerHTML='<!--[if IE '+b+']><i></i><![endif]-->',a.getElementsByTagName('i').length===1;},regPageNav:function(a,b){return a=[],b=function(d){d=d||c.lastRoute,d.slice(0,2)=='#!'&&(d=d.slice(2)),d.slice(0,1)=='#'&&(d=d.slice(1)),d.length>0&&(a=_.filter(a,function(g){var a=g.element,c=a.attr('href'),e=a.attr('phref');return c=c.split('#')[1],$.contains(f,a[0])?((c===d||c===d.replace(/\(.+\)/g,''))&&(a.addClass('page-nav-state-current'),e&&b(e)),!0):!1;}));},e.on('inited switched',function(){$('.page-nav-state-current').removeClass('page-nav-state-current'),b();}),function(c){var b=$(c);b.each(function(){var b=$(this);_.some(a,function(a){return a.element[0]===b[0]?!0:void 0;})||a.push({element:b});});};}(),alert:function(a){var e,c,b;a=_.extend({title:'\u63D0\u793A',content:'',iconType:'error',modal:!0,onSubmit:d.noop,submitText:'\u786E&nbsp;\u5B9A'},a||{});switch(a.iconType){case'info':b='&#xe603;';break;case'ask':b='&#xe606;';break;case'success':b='&#xe604;';break;case'error':b='&#xe605;';break;default:b='';break;}e={title:a.title,modal:a.modal,autoOpen:!0,showClose:!1,getTemplate:function(d){var b=d.split('MS_OPTION_FOOTER'),c='<div class="ui-dialog-footer fn-clear"><div class="ui-dialog-btns"><button type="button" class="submit-btn ui-dialog-btn" ms-click="submit">'+a.submitText+'</button>'+'</div>'+'</div>';return b[0]+'MS_OPTION_FOOTER'+c;},onOpen:function(){this.setContent('<div class="fn-clear"><i class="icon-tip icon-'+a.iconType+' fn-left">'+b+'</i>&nbsp;&nbsp;<span class="tip-content">'+a.content+'</span></div>',!0);},onClose:function(){$(this.widgetElement).remove();},submit:function(b){a.onSubmit.call(this,b),c.close();}},c=d.dialog({model:e}),$(c.widgetElement).addClass('global-alert global-alert-confirm');},confirm:function(a){var e,c,b;a=_.extend({title:'\u786E\u8BA4',content:'',iconType:'ask',modal:!0,onSubmit:d.noop,onCancel:d.noop,submitText:'\u786E&nbsp;\u5B9A',cancelText:'\u53D6&nbsp;\u6D88'},a||{});switch(a.iconType){case'info':b='&#xe603;';break;case'ask':b='&#xe606;';break;case'success':b='&#xe604;';break;case'error':b='&#xe605;';break;default:b='';break;}e={title:a.title,modal:a.modal,autoOpen:!0,showClose:!1,getTemplate:function(d){var b=d.split('MS_OPTION_FOOTER'),c='<div class="ui-dialog-footer fn-clear"><div class="ui-dialog-btns"><button type="button" class="submit-btn ui-dialog-btn" ms-click="submit">'+a.submitText+'</button>'+'<span class="separation"></span>'+'<button type="button" class="cancel-btn ui-dialog-btn" ms-click="cancel">'+a.cancelText+'</button>'+'</div>'+'</div>';return b[0]+'MS_OPTION_FOOTER'+c;},onOpen:function(){this.setContent('<div class="fn-clear"><i class="icon-tip icon-'+a.iconType+' fn-left">'+b+'</i>&nbsp;&nbsp;<span class="tip-content">'+a.content+'</span></div>',!0);},onClose:function(){$(this.widgetElement).remove();},submit:function(b){a.onSubmit.call(this,b)!==!1&&c.close();},cancel:function(b){a.onCancel.call(this,b)!==!1&&c.close();}},c=d.dialog({model:e}),$(c.widgetElement).addClass('global-confirm global-alert-confirm');},onLazyResize:function(b,a,c){var d;typeof a==='boolean'&&(c=a,a=0),$(h).resize(function(c){clearTimeout(d),d=setTimeout(function(){b();},a||0);}),c&&b();},adjustModuleCssUrl:function(a,f){var c=/url\s*\(\s*(['"]?)([^"'\)]*)\1\s*\)/gi,d,e=b.PUBLISH_MODEL;return d=b.MODULE_PATH,e==='product'?a:a.replace(c,function(b){var a;return b=b.replace(/\s/g,''),a=b.slice(4,-1).replace(/"|'/g,''),/^\/|https:|http:|data:/i.test(a)===!1&&(a=d+f+a),'url("'+a+'")';});},regGlobalMdExcept:function(a){return a=[],$('body').on('mousedown',function(b){a=_.reject(a,function(a){return _.some(a.element,function(a){return!$.contains(document.body,a[0]);});}),_.each(a,function(d){var a=d.element,c=d.handler;_.every(a,function(a){return!a.is(b.target)&&a.find(b.target).length===0?!0:void 0;})&&(c?c.call(this,b):a.hide());});}),function(b){a.push({element:_.map([].concat(b.element),function(a){return $(a);}),handler:b.handler});};}(),hasPermission:function(c){var a=b.getAppData('permission');return _.some(a,function(a){return a&&a.remark===c;});},jumpPage:function(b){var a=$('<a href="'+b+'"></a>');a.appendTo('body'),a[0].click(),a.remove();},keyToCamelize:function(b,c){var a=null;return b&&(a={},c?_.each(c,function(b){a[b]=a[_.str.dasherize(b)];}):_.each(_.keys(b),function(c){a[_.str.camelize(c)]=b[c];})),a;},log:function(b){var a=$('#logger');a.length||(a=$('<div id="logger"></div>'),a.css({position:'fixed',top:0,left:0,'z-index':10000,background:'white'}).appendTo('body')),a.html(j.stringify(b));},showGlobalMask:function(){var a=$('.global-mask');a.length||(a=$('<div class="global-mask"></div>'),a.appendTo('body')),a.show();},hideGlobalMask:function(){var a=$('.global-mask');a.hide();},setInputTextFocusOnce:function(b){var a=$(b);a.hasClass('input-focus')||a.get(0).focus();},getCursorPosition:function(g){var b={text:'',start:0,end:0},c=$(g)[0];if(a.setInputTextFocusOnce(g),c.setSelectionRange)b.start=c.selectionStart,b.end=c.selectionEnd,b.text=b.start!=b.end?c.value.substring(b.start,b.end):'';else if(document.selection){var d,e=document.selection.createRange(),f=document.body.createTextRange();for(f.moveToElementText(c),b.text=e.text,b.bookmark=e.getBookmark(),d=0;f.compareEndPoints('StartToStart',e)<0&&e.moveStart('character',-1)!==0;d++)c.value.charAt(d)=='\n'&&d++;b.start=d,b.end=b.text.length+b.start;}return b;},setCursorPosition:function(i,h){var d,e,c=$(i)[0];if(!h)return alert('\u5FC5\u987B\u5B9A\u4E49\u5149\u6807\u4F4D\u7F6E'),!1;if(d=h.start,e=h.end,c.setSelectionRange)a.setInputTextFocusOnce(i),c.setSelectionRange(d,e);else if(c.createTextRange){var f=c.createTextRange(),g,b;for(g=d,b=0;b<g;b++)c.value.charAt(b).search(/[\r\n]/)!=-1&&(d-=0.5);for(g=e,b=0;b<g;b++)c.value.charAt(b).search(/[\r\n]/)!=-1&&(e-=0.5);f.moveEnd('textedit',-1),f.moveStart('character',d),f.moveEnd('character',e-d),f.select();}},appendTextAtCursor:function(g,c){var d=$(g),e=d[0],f=$(g).val(),b=a.getCursorPosition(e);d.val(f.slice(0,b.start)+c+f.slice(b.end)),a.setCursorPosition(e,_.extend(b,{start:b.start+c.length,end:b.start+c.length}));},forceRefresh:function(){var a=d.History.getHash(window.location).slice(2);a?d.router.navigate(a):location.reload();},testType:{empty:function(b,c){var d=$(b).val().replace(' ','');return d.length>0?(a.selectTip(b,c,'hide'),!0):(a.selectTip(b,c,'show'),!1);},tel:function(b,c){var d=$(b).val(),e=/^(\({0,1}\d{3,4})\){0,1}(-){0,1}(\d{7,8})$/;return e.test(d)?(a.selectTip(b,c,'hide'),!0):(a.selectTip(b,c,'show'),!1);},mail:function(b,c){var d=$(b).val(),e=/^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/;return e.test(d)?(a.selectTip(b,c,'hide'),!0):(a.selectTip(b,c,'show'),!1);},mobile:function(b,c){var d=$(b).val().replace(' ',''),e=/^1[0-9]{10}$/;return e.test(d)?(a.selectTip(b,c,'hide'),!0):(a.selectTip(b,c,'show'),!1);},number:function(b,c){var d=$(b).val().replace(' ',''),e=/^[0-9]+$/;return e.test(d)?(a.selectTip(b,c,'hide'),!0):(a.selectTip(b,c,'show'),!1);}},getTips:function(a,b){var c=a.length;return b+1>c?(alert('\u7F3A\u5C11\u9519\u8BEF\u63D0\u793A\uFF01'),!1):a[b];},selectTip:function(b,d,c){var a=$(b).parent().find('div.ff-value-tip')[0];a?c=='show'?($(a).addClass('valid-error').text(d).show(),$(b).addClass('valid-error-field')):c=='hide'&&($(a).hide(),$(b).removeClass('valid-error-field'),$(a).removeClass('valid-error')):(a=$(b).parent().parent().find('div.ff-value-tip')[0],a?c=='show'?($(a).addClass('valid-error').text(d).show(),$(b).addClass('valid-error-field')):c=='hide'&&($(a).hide(),$(b).removeClass('valid-error-field'),$(a).removeClass('valid-error')):(a=$(b).parent().parent().parent().find('div.ff-value-tip')[0],a?c=='show'?($(a).addClass('valid-error').text(d).show(),$(b).addClass('valid-error-field')):c=='hide'&&($(a).hide(),$(b).removeClass('valid-error-field'),$(a).removeClass('valid-error')):($(b).parent().append("<div class='ff-value-tip valid-error'>"+d+'</div>'),$(b).addClass('valid-error-field'))));},typeFn:function(d,f,e){var b=!0;for(var c=0;c<f.length;c++)switch(f[c]){case'empty':b=a.testType.empty(d,a.getTips(e,c));if(!b)return!1;break;case'mobile':b=a.testType.mobile(d,a.getTips(e,c));if(!b)return!1;break;case'mail':b=a.testType.mail(d,a.getTips(e,c));if(!b)return!1;break;case'tel':b=a.testType.tel(d,a.getTips(e,c));if(!b)return!1;break;case'number':b=a.testType.number(d,a.getTips(e,c));if(!b)return!1;break;}return!0;},testStart:function(b){var c=$(b).attr('data-rules').split('&'),d=$(b).attr('data-tips').split('&'),e=$(b).attr('isempty');if(e){var f=$(b).val().replace(' ','');return f.length>0?a.typeFn(b,c,d):(a.selectTip(b,'','hide'),!0);}else return a.typeFn(b,c,d);},testing:function(e,f){var c=f||$('[isrule=true]',e),d,b=!0;return c.each(function(e,c){d=a.testStart(c),$(c).on('blur',function(){a.testStart(this);}),d||(b=!1);}),b;},testCancel:function(a){$('input',a).removeClass('valid-error-field'),$('textarea',a).removeClass('valid-error-field'),$('div.ff-value-tip',a).hide();}}),a;});