//From origin\asset\util.js
define("util",["avalon","mmRouter","events","json","dialog"],function(e,t,n,a){var i=this,r=document,o=this.erp,s=o.page,l={},c=Array.prototype.slice,u=new n;return s.pageEvent=u,l=_.extend(l,{generateID:function(){return"q13"+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},ajax:function(){var e=[];return function(t,n){t=_.extend({dataType:"json"},t||{}),n=_.extend({mask:!1,ajaxType:"none",withData:!0},n||{});var a,i,r,o,s,c=$(".ajax-mask");0===c.length&&(c=$('<div class="ajax-mask"></div>'),c.html('<div class="ajax-mask-inner"></div>'),c.appendTo("body")),c.removeClass("ajax-global-mask ajax-part-mask"),n.mask===!0?(c.addClass("ajax-global-mask"),c.show()):n.mask!==!1&&(c.addClass("ajax-part-mask"),a=$(n.mask),o=function(){i=a.position(),a.css({top:i.top,left:i.left,width:a.width(),height:a.height()})},s=function(){clearTimeout(r),r=setTimeout(function(){o()},300)},$(window).bind("resize",s),o(),c.show());var u=!1;if("abort"!=n.ajaxType&&"ignore"!=n.ajaxType||(_.some(e,function(e){var a,i,r=e.data,o=e.url;return o==t.url&&(!n.withData||n.withData&&_.isEqual(r,t.data))&&(a=e.xhr,i=a.state(),"pending"==i)?("abort"==n.ajaxType?a.abort():u=!0,!0):void 0}),!u)){var d,p;return d=$.ajax(t),p=l.generateID(),d.always(function(){(n.mask===!0||n.mask!==!1)&&(c.hide(),r&&clearTimeout(r),s&&$(window).unbind("resize",s)),e=_.reject(e,function(e){return e.id==p})}),e.push({xhr:d,url:t.url,data:t.data,id:p}),d}}}(),c2s:function(e,t){var n;return e.type=e.type||"post",e.dataType=e.dataType||"json",t=_.extend({mask:!0,ajaxType:"ignore",withData:!0},t||{}),n=l.ajax(e,t),n&&(n.done(function(e){e.flag||(e.timeout?location.href=o.BASE_PATH+"login.jsp":l.alert({content:e.message,iconType:"error"}))}),n.fail(function(){l.alert({content:"服务端请求失败",iconType:"error"})})),n},regRouter:function(n,a,i){var r,d,p=$(n);!i&&_.isFunction(a)&&(i=a,a=n),r=$(a),d=$(".page-mask",r);var m=function(e){var t=[];return _.each(e,function(e){var n=e.belongToPermission;n.length&&("all"===n||_.some(n,function(e){return l.hasPermission(e)}))&&(e.route&&t.push(_.extend({},e)),e.children&&(t=t.concat(m(e.children))))}),t},f=function(e){var t=[];return _.each(e,function(e){var n,a=e.belongToPermission;a.length&&("all"===a||_.some(a,function(e){return l.hasPermission(e)}))&&(n=_.extend({},e),t.push(n),e.children&&(n.children=f(e.children)))}),t},h=function(e,t){var n=s.cacheStore,a=n[e],i=a.pageEl;$(".page-state-active",p).removeClass("page-state-active"),i.addClass("page-state-active"),d.hide(),!t&&u.trigger("switched",i,e,a.routeData)},v=function(t){var n=s.cacheStore,a=n[t],i=a.routeData,r=a.pageEl;a.$remove(r,t,i),r.off(),r.remove(),n[t]=null,delete n[t],e.vmodels[t]=null,delete e.vmodels[t],u.trigger("removed",t)};0===d.length&&(d=$('<div class="page-mask"></div>'),d.appendTo(r)),l.ajax({url:o.PAGE_PATH+"router.json",dataType:"json",type:"get",success:function(e){var n=e.rows;s.routes=f(n),s.lastPagePath="",s.lastRoute="",s.lastRouteData=null,_.each(m(n),function(e){var n,a,i,r=e.route,l=[].concat(e.css),m=[].concat(e.js),f=e.html,g=e.isCache;t.router.get(r,function(){var t=this,T=r.slice(1),T=T.replace(/\(.+\)/g,""),T=T.replace(/\/:.+/g,""),T=T.replace(/\/\?.+/g,""),b=T.replace(/\//g,"-"),y=T.split("/").pop(),x=s.cacheStore||{},w=s.lastPagePath;return b="page-"+b,w&&(w=w.replace(/\//g,"-"),w="page-"+w,x[w]&&!x[w].isCache&&v(w)),s.lastPagePath=T,s.lastRoute=r,s.lastRouteData=e,d.show(),x[b]&&x[b].isCache?void h(b):(n||(l="development"===o.PUBLISH_MODEL?_.map(l,function(e){return e===!0?"css!"+o.PAGE_PATH+T+"/"+y+".css":"css!"+o.ORIGIN_PATH+e}):[],m=_.map(m,function(e){var t;return t=e===!0?o.PAGE_PATH+T+"/"+y+".js":o.ORIGIN_PATH+e,"development"===o.PUBLISH_MODEL?t:"product"===o.PUBLISH_MODEL?t.slice(o.PORTAL_PATH.length).replace(/[\.|\\|/|_|-]/g,""):void 0}),a=f?f===!0?"text!"+o.PAGE_PATH+T+"/"+y+".html":"text!"+o.ORIGIN_PATH+f:"text!"+o.PAGE_PATH+T+"/"+y+".html",n=l.concat(a,m)),void setTimeout(function(){require(n,function(){var r=c.call(arguments,0),o=i||r[0],d=r[r.length-1],m={};_.extend(m,e,t);var f=$("<div></div>");f.addClass("page "+b).attr("ms-controller",b).appendTo(p),f.html(o),i||(i=o,n.splice(l.length,1)),d.$init?d.$init(f,b,m):alert("请在页面（"+a+"）逻辑中设置$init初始化函数"),x[b]={pageEl:f,isCache:g,routeData:m,$remove:d.$remove||function(){}},s.cacheStore=x,u.trigger("inited",f,b,m),h(b,!0)})},300))})}),t.history.start({html5Mode:!1}),i&&i.call(this,e)}})},isIE:function(e){var t=r.createElement("b");return t.innerHTML="<!--[if IE "+e+"]><i></i><![endif]-->",1===t.getElementsByTagName("i").length},regPageNav:function(){var e=[],t=function(n){n=n||s.lastRoute,"#!"==n.slice(0,2)&&(n=n.slice(2)),"#"==n.slice(0,1)&&(n=n.slice(1)),n.length>0&&(e=_.filter(e,function(e){var a=e.element,i=a.attr("href"),o=a.attr("phref");return i=i.split("#")[1],$.contains(r,a[0])?((i===n||i===n.replace(/\(.+\)/g,""))&&(a.addClass("page-nav-state-current"),o&&t(o)),!0):!1}))};return u.on("inited switched",function(){$(".page-nav-state-current").removeClass("page-nav-state-current"),t()}),function(t){var n=$(t);n.each(function(){var t=$(this);_.some(e,function(e){return e.element[0]===t[0]?!0:void 0})||e.push({element:t})})}}(),alert:function(t){var n,a,i;switch(t=_.extend({title:"提示",content:"",iconType:"error",modal:!0,onSubmit:e.noop,submitText:"确&nbsp;定"},t||{}),t.iconType){case"info":i="&#xe603;";break;case"ask":i="&#xe606;";break;case"success":i="&#xe604;";break;case"error":i="&#xe605;";break;default:i=""}n={title:t.title,modal:t.modal,autoOpen:!0,showClose:!1,getTemplate:function(e){var n=e.split("MS_OPTION_FOOTER"),a='<div class="ui-dialog-footer fn-clear"><div class="ui-dialog-btns"><button type="button" class="submit-btn ui-dialog-btn" ms-click="submit">'+t.submitText+"</button></div></div>";return n[0]+"MS_OPTION_FOOTER"+a},onOpen:function(){this.setContent('<div class="fn-clear"><i class="icon-tip icon-'+t.iconType+' fn-left">'+i+'</i>&nbsp;&nbsp;<span class="tip-content">'+t.content+"</span></div>",!0)},onClose:function(){$(this.widgetElement).remove()},submit:function(e){t.onSubmit.call(this,e),a.close()}},a=e.dialog({model:n}),$(a.widgetElement).addClass("global-alert global-alert-confirm")},confirm:function(t){var n,a,i;switch(t=_.extend({title:"确认",content:"",iconType:"ask",modal:!0,onSubmit:e.noop,onCancel:e.noop,submitText:"确&nbsp;定",cancelText:"取&nbsp;消"},t||{}),t.iconType){case"info":i="&#xe603;";break;case"ask":i="&#xe606;";break;case"success":i="&#xe604;";break;case"error":i="&#xe605;";break;default:i=""}n={title:t.title,modal:t.modal,autoOpen:!0,showClose:!1,getTemplate:function(e){var n=e.split("MS_OPTION_FOOTER"),a='<div class="ui-dialog-footer fn-clear"><div class="ui-dialog-btns"><button type="button" class="submit-btn ui-dialog-btn" ms-click="submit">'+t.submitText+'</button><span class="separation"></span><button type="button" class="cancel-btn ui-dialog-btn" ms-click="cancel">'+t.cancelText+"</button></div></div>";return n[0]+"MS_OPTION_FOOTER"+a},onOpen:function(){this.setContent('<div class="fn-clear"><i class="icon-tip icon-'+t.iconType+' fn-left">'+i+'</i>&nbsp;&nbsp;<span class="tip-content">'+t.content+"</span></div>",!0)},onClose:function(){$(this.widgetElement).remove()},submit:function(e){t.onSubmit.call(this,e)!==!1&&a.close()},cancel:function(e){t.onCancel.call(this,e)!==!1&&a.close()}},a=e.dialog({model:n}),$(a.widgetElement).addClass("global-confirm global-alert-confirm")},onLazyResize:function(e,t,n){var a;"boolean"==typeof t&&(n=t,t=0),$(i).resize(function(){clearTimeout(a),a=setTimeout(function(){e()},t||0)}),n&&e()},adjustModuleCssUrl:function(e,t){var n,a=/url\s*\(\s*(['"]?)([^"'\)]*)\1\s*\)/gi,i=o.PUBLISH_MODEL;return n=o.MODULE_PATH,"product"===i?e:e.replace(a,function(e){var a;return e=e.replace(/\s/g,""),a=e.slice(4,-1).replace(/"|'/g,""),/^\/|https:|http:|data:/i.test(a)===!1&&(a=n+t+a),'url("'+a+'")'})},regGlobalMdExcept:function(){var e=[];return $("body").on("mousedown",function(t){e=_.reject(e,function(e){return _.some(e.element,function(e){return!$.contains(document.body,e[0])})}),_.each(e,function(e){var n=e.element,a=e.handler;_.every(n,function(e){return e.is(t.target)||0!==e.find(t.target).length?void 0:!0})&&(a?a.call(this,t):n.hide())})}),function(t){e.push({element:_.map([].concat(t.element),function(e){return $(e)}),handler:t.handler})}}(),hasPermission:function(e){var t=o.getAppData("permission");return _.some(t,function(t){return t&&t.remark===e})},jumpPage:function(e){var t=$('<a href="'+e+'"></a>');t.appendTo("body"),t[0].click(),t.remove()},keyToCamelize:function(e,t){var n=null;return e&&(n={},t?_.each(t,function(e){n[e]=n[_.str.dasherize(e)]}):_.each(_.keys(e),function(t){n[_.str.camelize(t)]=e[t]})),n},log:function(e){var t=$("#logger");t.length||(t=$('<div id="logger"></div>'),t.css({position:"fixed",top:0,left:0,"z-index":1e4,background:"white"}).appendTo("body")),t.html(a.stringify(e))},showGlobalMask:function(){var e=$(".global-mask");e.length||(e=$('<div class="global-mask"></div>'),e.appendTo("body")),e.show()},hideGlobalMask:function(){var e=$(".global-mask");e.hide()},setInputTextFocusOnce:function(e){var t=$(e);t.hasClass("input-focus")||t.get(0).focus()},getCursorPosition:function(e){var t={text:"",start:0,end:0},n=$(e)[0];if(l.setInputTextFocusOnce(e),n.setSelectionRange)t.start=n.selectionStart,t.end=n.selectionEnd,t.text=t.start!=t.end?n.value.substring(t.start,t.end):"";else if(document.selection){var a,i=document.selection.createRange(),r=document.body.createTextRange();for(r.moveToElementText(n),t.text=i.text,t.bookmark=i.getBookmark(),a=0;r.compareEndPoints("StartToStart",i)<0&&0!==i.moveStart("character",-1);a++)"\n"==n.value.charAt(a)&&a++;t.start=a,t.end=t.text.length+t.start}return t},setCursorPosition:function(e,t){var n,a,i=$(e)[0];if(!t)return alert("必须定义光标位置"),!1;if(n=t.start,a=t.end,i.setSelectionRange)l.setInputTextFocusOnce(e),i.setSelectionRange(n,a);else if(i.createTextRange){var r,o,s=i.createTextRange();for(r=n,o=0;r>o;o++)-1!=i.value.charAt(o).search(/[\r\n]/)&&(n-=.5);for(r=a,o=0;r>o;o++)-1!=i.value.charAt(o).search(/[\r\n]/)&&(a-=.5);s.moveEnd("textedit",-1),s.moveStart("character",n),s.moveEnd("character",a-n),s.select()}},appendTextAtCursor:function(e,t){var n=$(e),a=n[0],i=$(e).val(),r=l.getCursorPosition(a);n.val(i.slice(0,r.start)+t+i.slice(r.end)),l.setCursorPosition(a,_.extend(r,{start:r.start+t.length,end:r.start+t.length}))},forceRefresh:function(){var t=e.History.getHash(window.location).slice(2);t?e.router.navigate(t):location.reload()},testType:{empty:function(e,t){var n=$(e).val().replace(" ","");return n.length>0?(l.selectTip(e,t,"hide"),!0):(l.selectTip(e,t,"show"),!1)},tel:function(e,t){var n=$(e).val(),a=/^(\({0,1}\d{3,4})\){0,1}(-){0,1}(\d{7,8})$/;return a.test(n)?(l.selectTip(e,t,"hide"),!0):(l.selectTip(e,t,"show"),!1)},mail:function(e,t){var n=$(e).val(),a=/^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/;return a.test(n)?(l.selectTip(e,t,"hide"),!0):(l.selectTip(e,t,"show"),!1)},mobile:function(e,t){var n=$(e).val().replace(" ",""),a=/^1[0-9]{10}$/;return a.test(n)?(l.selectTip(e,t,"hide"),!0):(l.selectTip(e,t,"show"),!1)},number:function(e,t){var n=$(e).val().replace(" ",""),a=/^[0-9]+$/;return a.test(n)?(l.selectTip(e,t,"hide"),!0):(l.selectTip(e,t,"show"),!1)}},getTips:function(e,t){var n=e.length;return t+1>n?(alert("缺少错误提示！"),!1):e[t]},selectTip:function(e,t,n){var a=$(e).parent().find("div.ff-value-tip")[0];a?"show"==n?($(a).addClass("valid-error").text(t).show(),$(e).addClass("valid-error-field")):"hide"==n&&($(a).hide(),$(e).removeClass("valid-error-field")):(a=$(e).parent().parent().find("div.ff-value-tip")[0],a?"show"==n?($(a).addClass("valid-error").text(t).show(),$(e).addClass("valid-error-field")):"hide"==n&&($(a).hide(),$(e).removeClass("valid-error-field")):(a=$(e).parent().parent().parent().find("div.ff-value-tip")[0],a?"show"==n?($(a).addClass("valid-error").text(t).show(),$(e).addClass("valid-error-field")):"hide"==n&&($(a).hide(),$(e).removeClass("valid-error-field")):($(e).parent().append("<div class='ff-value-tip valid-error'>"+t+"</div>"),$(e).addClass("valid-error-field"))))},typeFn:function(e,t,n){for(var a=!0,i=0;i<t.length;i++)switch(t[i]){case"empty":if(a=l.testType.empty(e,l.getTips(n,i)),!a)return!1;break;case"mobile":if(a=l.testType.mobile(e,l.getTips(n,i)),!a)return!1;break;case"mail":if(a=l.testType.mail(e,l.getTips(n,i)),!a)return!1;break;case"tel":if(a=l.testType.tel(e,l.getTips(n,i)),!a)return!1;break;case"number":if(a=l.testType.number(e,l.getTips(n,i)),!a)return!1}return!0},testStart:function(e){var t=$(e).attr("data-rules").split("&"),n=$(e).attr("data-tips").split("&"),a=$(e).attr("isempty");if(a){var i=$(e).val().replace(" ","");return i>0?l.typeFn(e,t,n):(l.selectTip(e,"","hide"),!0)}return l.typeFn(e,t,n)},testing:function(e,t){var n,a=t||$("[isrule=true]",e),i=!0;return a.each(function(e,t){n=l.testStart(t),$(t).on("blur",function(){l.testStart(this)}),n||(i=!1)}),i},testCancel:function(e){$("input",e).removeClass("valid-error-field"),$("textarea",e).removeClass("valid-error-field"),$("div.ff-value-tip",e).hide()}})});